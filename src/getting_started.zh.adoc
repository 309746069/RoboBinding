入门
====
:Revision: 0.8.2
:toc:
:numbered:
:imagesdir: ./images
:source-highlighter: pygments

RoboBinding是什么?
------------------
*Android应用的粘接剂* - RoboBinding是一个实现了数据绑定 http://martinfowler.com/eaaDev/PresentationModel.html[Presentation Model] 模式的Android开源框架。RoboBinding 帮助你编写更可读，易于测试与维护的UI代码。

属性绑定
~~~~~~~~

在你的layout xml里声明一个属性绑定:
[source,xml]
----
<EditText android:layout_width="fill_parent"
	  android:layout_height="wrap_content"
	  bind:text="${superHeroName}" />
----

增加一个 http://baike.baidu.com/view/183175.htm[pojo] presentation model 类并提供相应的属性:
[source,java]
----
public void setSuperHeroName(String superHeroName) {
	this.superHeroName = superHeroName;
}

public String getSuperHeroName() {
	return superHeroName;
}
----
RoboBinding 将自动的同步View与Presentation Model。

事件处理
~~~~~~~~

在你的layout xml里声明一个事件绑定:
[source,xml]
----
<ListView android:layout_width="fill_parent"
	  android:layout_height="fill_parent"
	  bind:onItemClick="superHeroSelected" />
----

增加一个 http://baike.baidu.com/view/183175.htm[pojo] presentation model 类并提供相应的事件处理方法:
[source,java]
----
public void superHeroSelected(ItemClickEvent event) {
	SuperHero chosenSuperHero = this.superHeroes.get(event.getPosition());
	chosenSuperHero.summon();
}
----
当item click 事件被触发时，RoboBinding 将自动调用相应的方法。

Hello RoboBinding
-----------------
让我们观看由Robert Taylor做的http://skillsmatter.com/podcast/os-mobile-server/core-dev-talk-robobinding[框架介绍视频]。

开发环境
~~~~~~~~
* Eclipse(更新中。。。 请参考link:getting_started.html#_environment_setup[英文文档])
* ProGuard(更新中。。。 请参考link:getting_started.html#_environment_setup[英文文档])
* Maven(更新中。。。 请参考link:old_maven.html[旧文档])

Album唱片集例子项目学习
-----------------------
项目中所带的Album唱片集例子是将Martin Fowler的原始版本翻译成基于RoboBinding的Android版本(Martin Fowler基于.Net的 http://martinfowler.com/eaaDev/PresentationModel.html[原始版本] )。
可以从 https://github.com/RoboBinding/RoboBinding[RoboBinding链接] 下找到robobinding-sample项目。

将项目导入Eclipse。文件->导入->Android->已存在的Android代码到工作区->浏览选择robobinding-sample文件夹，导入即可。

.Album唱片集例子原型
image::album_sample_prototype.png[]
以上是Album唱片集例子原型图。项目遵循RoboBinding应用的标准结构，即一个Activity由Activity主Java文件，Layout文件与PresentationModel Java文件组成。
项目源代码中包含以下几个包：org.robobinding.albumsample.activity包含所有Activity的主Java文件，org.robobinding.albumsample.presentationmodel包含所有PresentationModel Java文件，
org.robobinding.albumsample.model仅包含一个Album实体实现文件，org.robobinding.albumsample.store包含一个基于内存Album实体存储实现AlbumStore。
接下来列出上述五张图所对应的实现文件。
图[Home Activity]由org.robobinding.albumsample.activity.HomeActivity，home_activity.xml与org.robobinding.albumsample.presentationmodel.HomePresentationModel组成。
图[View Albums Activity]由org.robobinding.albumsample.activity.ViewAlbumsActivity，view_albums_activity.xml与org.robobinding.albumsample.presentationmodel.ViewAlbumsPresentationModel组成;
其唱片集每行的唱片信息由org.robobinding.albumsample.presentationmodel.AlbumItemPresentationModel与album_row.xml组成；以及一个当唱片集为空时Layout显示文件albums_empty_view.xml。
图[Create Album Activity]与图[Edit Album Activity]由相同的org.robobinding.albumsample.activity.CreateEditAlbumActivity，create_edit_album_activity.xml与org.robobinding.albumsample.presentationmodel.CreateEditAlbumPresentationModel组成。
图[View Album Activity]由org.robobinding.albumsample.activity.ViewAlbumActivity，view_album_activity.xml与org.robobinding.albumsample.presentationmodel.ViewAlbumPresentationModel组成；
其删除对话框由org.robobinding.albumsample.activity.DeleteAlbumDialog，delete_album_dialog.xml与DeleteAlbumDialogPresentationModel组成。

以下以[View Albums Activity]为例，对源代码做简单介绍。Activity主Java文件ViewAlbumsActivity只做了一件事，就是把Layout文件view_albums_activity.xml与ViewAlbumsPresentationModel关联起来。
view_albums_activity.xml里包含了三个子视图按顺序为TextView, ListView与Button。TextView没有包含任何绑定信息。
ListView的++bind:source="\{albums\}"++绑定到ViewAlbumsPresentationModel.albums数据集属性。
++bind:onItemClick="viewAlbum"++绑定到ViewAlbumsPresentationModel.viewAlbum(ItemClickEvent)方法，单击某个唱片项时，该事件方法将被调用。
++bind:emptyViewLayout="@layout/albums_empty_view"++设置了当唱片集为空时的显示内容Layout。
++bind:itemLayout="@layout/album_row"++设置了唱片项的行显示Layout，结合在ViewAlbumsPresentationModel.albums上给出的数据项PresentationModel，即++@ItemPresentationModel(AlbumItemPresentationModel.class)++，
来显示每一个唱片行。在album_row.xml里包含了两个简单的TextView，其++bind:text="\{title\}"++与++bind:text="\{artist\}"++分别绑定到AlbumItemPresentationModel.title/artist属性。
在view_albums_activity.xml里的最后一个Button视图，++bind:onClick="createAlbum"++绑定到ViewAlbumsPresentationModel.createAlbum()方法。


创建自己的属性绑定实现
----------------------
自定义组件
~~~~~~~~~~
当我们开发UI界面时，经常将整个界面分块，把几个相关的小widget组合成一个大的自定义组件。这样便于重用这些自定义组件且更易于维护。RoboBinding使得自定义组件更易于使得。

.自定义 Title Description Bar
image::custom_component.png[]

以上白色边框的view为简单自定义组件。该组件包含了标题与描述两个部分。在输入新的标题与描述后，点击'Apply'，自定义组件的内容就更新为新的内容。
可以从https://github.com/weicheng113/robobinding-gallery[RoboBinding Widget Gallery]找到完整的代码。
以下为在layout xml中使用自定义组件：
[source,xml]
----
<org.robobinding.gallery.model.customcomponent.TitleDescriptionBar
	    bind:title="{title}"
	    bind:description="{description}"/>
----
实现自定义组件
^^^^^^^^^^^^^^
以下是TitleDescriptionBar自定义组件的主要实现代码部分(如何实现自定义组件，请参考http://developer.android.com/guide/topics/ui/custom-components.html[Android文档]):
[source,java]
----
public class TitleDescriptionBar extends LinearLayout {
    private TextView title;
    private TextView description;

    public TitleDescriptionBar(Context context, AttributeSet attrs) {
		this(context, attrs, R.layout.title_description_bar);
    }

    protected TitleDescriptionBar(Context context, AttributeSet attrs, int layoutId) {
		super(context, attrs);

		LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
		inflater.inflate(layoutId, this);
		title = (TextView) findViewById(R.id.title);
		description = (TextView) findViewById(R.id.description);
		...
    }

    public void setTitle(CharSequence titleText) {
		title.setText(titleText);
    }

    public void setDescription(CharSequence descriptionText) {
		description.setText(descriptionText);
    }
}
----
++title_description_bar.xml++
[source,xml]
----
<merge xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:bind="http://robobinding.org/android">
    <TextView android:id="@+id/title"/>
    <TextView android:text=": "/>
  	<TextView android:id="@+id/description"/>
----
实现绑定属性
^^^^^^^^^^^^
TitleDescriptionBar有标题与描述两个绑定属性，对应的实现分别是TitleAttribute与DescriptionAttribute。最后绑定属性映射TitleDescriptionBarAttributeMapper将属性映射到相应的实现类。
[source,java]
----
public class TitleAttribute extends AbstractTextAttribute {
    @Override
    protected void updateText(CharSequence newText) {
        view.setTitle(newText);
    }
}

public class DescriptionAttribute extends AbstractTextAttribute {
    @Override
    protected void updateText(CharSequence newText) {
	view.setDescription(newText);
    }
}

public class TitleDescriptionBarAttributeMapper implements BindingAttributeMapper<TitleDescriptionBar> {
    @Override
    public void mapBindingAttributes(BindingAttributeMappings<TitleDescriptionBar> mappings) {
        mappings.mapPropertyAttribute(TitleAttribute.class, "title");
        mappings.mapPropertyAttribute(DescriptionAttribute.class, "description");
    }
}
----
注册绑定属性映射类
^^^^^^^^^^^^^^^^^^
通过org.robobinding.binder.BinderFactoryBuilder注册绑定属性映射类。
[source,java]
----
BinderFactory binderFactory = new BinderFactoryBuilder()
        	.mapView(TitleDescriptionBar.class, new TitleDescriptionBarAttributeMapper())
        	.build();
ActivityBinder activityBinder = binderFactory.createActivityBinder(this, true);
activityBinder.inflateAndBind(R.layout.custom_component_activity, presentationModel);
----
我们可以为任何的第三方组件编写属性绑定实现，来简化第三方组件的使用。

覆盖已有的属性绑定实现
~~~~~~~~~~~~~~~~~~~~~~
当RoboBinding框架已有的绑定属性不满足需求或没有相应的属性绑定实现时，我们有两种选择。第一种是修改框架代码，增加缺少的绑定属性(我们希望大家都参与贡献更多的绑定属性实现)。
第二种是不更改框架，实现相应的绑定属性与绑定属性映射类，然后注册覆盖已有的框架所提供的默认实现。
以第二种方式为例，我们来覆盖框架已有的http://developer.android.com/reference/android/widget/ImageView.html[ImageView]属性绑定实现++org.robobinding.viewattribute.imageview++。

实现新的绑定属性与映射类
^^^^^^^^^^^^^^^^^^^^^^^^
[source,java]
----
public class MyImageViewAttributeMapper implements BindingAttributeMapper<ImageView> {
    @Override
    public void mapBindingAttributes(BindingAttributeMappings<ImageView> mappings) {
	mappings.mapPropertyAttribute(MyImageSourceAttribute.class, "src");
    }

}

public class MyImageSourceAttribute extends org.robobinding.viewattribute.imageview.ImageSourceAttribute {
    @Override
    protected AbstractPropertyViewAttribute<ImageView, ?> createPropertyViewAttribute(Class<?> propertyType) {
		if (String.class.isAssignableFrom(propertyType)) {
			return new UrlImageSourceAttribute();
		} else {
			return super.createPropertyViewAttribute(propertyType);
		}
    }

    static class UrlImageSourceAttribute extends AbstractReadOnlyPropertyViewAttribute<ImageView, String> {
		@Override
		protected void valueModelUpdated(String url) {
			Bitmap image = loadBitmapFromUrl(url);//load image from given url.
			view.setImageBitmap(image);
		}
	}
}
----
注册覆盖框架已有的实现
^^^^^^^^^^^^^^^^^^^^^^
[source,java]
----
BinderFactory binderFactory = new BinderFactoryBuilder()
        	.mapView(ImageView.class, new MyImageViewAttributeMapper())
        	.build();
----


Layout文件Robobinding语法校验器插件
-----------------------------------
更新中。。。  请参考link:old_validator_plugin.html[旧文档]

其它资源
--------
*2012年一月* Robert Taylor 写了一些入门的文章在 http://roberttaylor426.blogspot.com/2011/11/hello-robobinding-part-1.html[这里] 和 http://roberttaylor426.blogspot.com/2012/01/hello-robobinding-part-2.html[这里]。

*2012年二月* 在London SkillsMatter，Robert Taylor作的RoboBinding介绍视频可以在 http://skillsmatter.com/podcast/os-mobile-server/core-dev-talk-robobinding[这里]找到。

*RoboBinding Widget Gallery* Cheng Wei 建立了https://github.com/weicheng113/robobinding-gallery[RoboBinding Widget Gallery]项目来展示所支持绑定属性的用法。
